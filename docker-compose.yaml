version: '3.8'

services:
  go2rtc:
    image: alexxit/go2rtc:latest
    restart: unless-stopped
    environment:
      - TZ=Asia/Bangkok
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.bangkokcam.rule=Host(`cam.bangkokcam.com`)"
      - "traefik.http.routers.bangkokcam.entrypoints=websecure"
      - "traefik.http.routers.bangkokcam.tls=true"
      - "traefik.http.services.bangkokcam.loadbalancer.server.port=1984"
    command: >
      sh -c '
      mkdir -p /config &&
      echo "streams:" > /config/go2rtc.yaml &&
      echo "  sukhumvit:" >> /config/go2rtc.yaml &&
      echo "    - rtsp://ekkamaicam:$$CAMERA_PASSWORD@home.bangkokcam.com:8554/stream2" >> /config/go2rtc.yaml &&
      echo "api:" >> /config/go2rtc.yaml &&
      echo "  listen: \":1984\"" >> /config/go2rtc.yaml &&
      echo "webrtc:" >> /config/go2rtc.yaml &&
      echo "  listen: \":8555\"" >> /config/go2rtc.yaml &&
      go2rtc
      '
